
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reporte de Asignaciones</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #ffd600;
      margin: 0;
      padding: 2em;
      display: flex;
      flex-direction: column;
      align-items: center;
      zoom: 0.55; /* 45% smaller overall (10% larger than 0.5) */
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 1em;
    }

    table {
      border-collapse: collapse;
      width: 90%;
      max-width: 1000px;
      background: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      overflow: hidden;
    }

    th, td {
      padding: 1em;
      text-align: center;
    }

    th {
      background-color: #8bb3dd;
      color: white;
      font-size: 1.1em;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    tr:hover {
      background-color: #eaf2f8;
    }
  </style>
</head>
<body>
  <h1>Información de Unidades</h1>
  
  <div style="margin: 2em 0; text-align: center;">
    <label for="fechaSelector" style="font-size: 1.2em; font-weight: bold; margin-right: 1em;">Seleccionar Fecha:</label>
    <input type="date" id="fechaSelector" style="padding: 0.5em; font-size: 1.1em; border-radius: 6px; border: 1px solid #ccc;">
  </div>
  
  <table id="tablaReporte">
    <thead>
      <tr>
        <th>Línea</th>
        <th>Unidad</th>
        <th>KM Recorridos</th>
      </tr>
    </thead>
    <tbody>
      <!-- Contenido dinámico -->
    </tbody>
  </table>

  <h2 style="text-align: center; color: #2c3e50; margin-top: 3em; margin-bottom: 1em;">Control de Velocidad</h2>
  <table id="tablaVelocidad">
    <thead>
      <tr>
        <th>Unidad</th>
        <th>Superó 60 km/h</th>
        <th>Hora</th>
      </tr>
    </thead>
    <tbody>
      <!-- Contenido dinámico -->
    </tbody>
  </table>

  <div style="text-align: center; margin-top: 3em;">
    <button onclick="window.location.href='menu.html'" style="background: #8bb3dd; color: #fff; border: none; padding: 1em 2em; font-size: 1.2em; border-radius: 8px; cursor: pointer; transition: background 0.2s;">Volver al Menú</button>
  </div>

  <script>
    // Establecer fecha actual por defecto
    document.getElementById('fechaSelector').value = new Date().toISOString().split('T')[0];

    async function cargarDatos(fechaFiltro = null) {
      const tbody = document.querySelector("#tablaReporte tbody");
      tbody.innerHTML = '';

      // Traer asignaciones del backend
      let url = '/api/asignaciones';
      if (fechaFiltro) {
        url += `?fecha=${encodeURIComponent(fechaFiltro)}`;
      }
      const resp = await fetch(url);
      const datos = resp.ok ? await resp.json() : [];

      // Mostrar solo los 12 servicios específicos
      const serviciosEspecificos = [
        { linea: 'Línea 1', servicio: 's1' },
        { linea: 'Línea 1', servicio: 's2' },
        { linea: 'Línea 1', servicio: 's3' },
        { linea: 'Línea 2', servicio: 's1' },
        { linea: 'Línea 2', servicio: 's2' },
        { linea: 'Línea 3', servicio: 's1' },
        { linea: 'Línea 3', servicio: 's2' },
        { linea: 'Línea 3', servicio: 's3' },
        { linea: 'Línea 4', servicio: 's1' },
        { linea: 'Línea 4', servicio: 's2' },
        { linea: 'Línea 5', servicio: 's1' },
        { linea: 'Línea 5', servicio: 's2' }
      ];

      serviciosEspecificos.forEach(servicio => {
        const item = datos.find(d => d.linea === servicio.linea && d.servicio === servicio.servicio);
        const fila = document.createElement("tr");
        
        if (item) {
          fila.innerHTML = `
            <td>${item.linea}</td>
            <td>${item.coche}</td>
            <td>${item.km || '—'}</td>
          `;
        } else {
          fila.innerHTML = `
            <td>${servicio.linea}</td>
            <td>-</td>
            <td>—</td>
          `;
        }
        tbody.appendChild(fila);
      });
    }

    async function cargarDatosVelocidad() {
      const tbodyVelocidad = document.querySelector("#tablaVelocidad tbody");
      tbodyVelocidad.innerHTML = '';
      try {
        const resp = await fetch('/api/velocidad');
        const datos = resp.ok ? await resp.json() : [];
        if (datos.length === 0) {
          const fila = document.createElement("tr");
          fila.innerHTML = '<td colspan="3" style="text-align: center; color: #7f8c8d; font-style: italic;">No hay datos de velocidad disponibles</td>';
          tbodyVelocidad.appendChild(fila);
        } else {
          datos.forEach(item => {
            const hora = new Date(item.timestamp).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
            const fila = document.createElement("tr");
            fila.innerHTML = `
              <td>${item.coche || '-'}</td>
              <td style="color: ${item.velocidad > 60 ? 'red' : 'green'}; font-weight: bold;">${item.velocidad > 60 ? 'Sí' : 'No'}</td>
              <td>${hora}</td>
            `;
            tbodyVelocidad.appendChild(fila);
          });
        }
      } catch (e) {
        const fila = document.createElement("tr");
        fila.innerHTML = '<td colspan="3" style="text-align: center; color: #7f8c8d; font-style: italic;">Error cargando datos</td>';
        tbodyVelocidad.appendChild(fila);
      }
    }

    document.getElementById('fechaSelector').addEventListener('change', function() {
      const fechaSeleccionada = this.value;
      if (fechaSeleccionada) {
        cargarDatos(fechaSeleccionada);
      }
    });

    cargarDatos(new Date().toISOString().split('T')[0]);
    cargarDatosVelocidad();
  </script>
</body>
</html>
